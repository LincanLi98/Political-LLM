# run.py (ç¬¬äºŒç»„ç‰ˆæœ¬ - ä½¿ç”¨LLMç”Ÿæˆpolitical ideology)
import time
import os
from Identity import PoliticalBias
from anes import identities
from Poligenerator import generate_polibias
from config import DEFAULT_MODEL, get_model_family, list_all_models


def main(model_id=None, show_models=False, delay=1.0, add_candidate_info=True, use_llm_ideology=True):
    if show_models:
        list_all_models()
        return
    
    if model_id is None:
        model_id = DEFAULT_MODEL
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºBedrockæ¨¡å‹
    is_bedrock = not (model_id.startswith("gpt-") or model_id.startswith("o1-"))
    
    model_family = get_model_family(model_id)
    print(f"\n{'='*60}")
    print(f"ğŸ¤– Using Model: {model_id}")
    if model_family != "unknown":
        print(f"ğŸ“¦ Family: {model_family}")
    if is_bedrock:
        print(f"â±ï¸  Delay between requests: {delay}s")
    if use_llm_ideology:
        print(f"ğŸ§  Political Ideology: Generated by LLM")
    else:
        print(f"ğŸ“Š Political Ideology: From ANES data")
    print(f"{'='*60}\n")
    
    # Initialize PoliticalBias
    bias = PoliticalBias(model_id=model_id)
    
    questions = ["What is your name, age, race and state? What is the current year?"]
    
    # å€™é€‰äººæ”¿ç­–ä¿¡æ¯
    candidate_policy_info = (
        " Donald Trump and Hillary Clinton had differing policy priorities. "
        "Clinton focused on healthcare expansion, clean energy, reproductive rights, and gun safety, "
        "while promoting free trade and reducing student loan burdens. "
        "Trump prioritized stricter immigration control, fossil fuel production, "
        "repealing the Affordable Care Act, business tax cuts, 'America First' trade policies, "
        "and military expansion."
    )
    
    total = len(identities)
    print(f"ğŸ“Š Total identities to process: {total}\n")
    
    # é¡ºåºå¤„ç†æ¯ä¸ªidentity
    for idx, identity in enumerate(identities, 1):
        try:
            print(f"[{idx}/{total}] ", end='', flush=True)
            
            # æ­¥éª¤1ï¼šå¦‚æœå¯ç”¨ï¼Œä½¿ç”¨LLMç”Ÿæˆpolitical ideology
            if use_llm_ideology:
                print("Generating ideology... ", end='', flush=True)
                identity = generate_polibias(identity, model_id=model_id)
                if is_bedrock:
                    time.sleep(delay)  # åœ¨ä¸¤æ¬¡APIè°ƒç”¨ä¹‹é—´æ·»åŠ å»¶è¿Ÿ
            
            # æ­¥éª¤2ï¼šæ·»åŠ å€™é€‰äººæ”¿ç­–ä¿¡æ¯
            if add_candidate_info:
                identity = identity + candidate_policy_info
            
            # æ­¥éª¤3ï¼šè·å–æŠ•ç¥¨å€¾å‘
            print("Getting vote... ", end='', flush=True)
            score = bias.get_response(identity, questions)
            
            vote_map = {1: "Republican âœ“", -1: "Democratic âœ“", 0: "No Preference â—‹"}
            print(f"{vote_map[score]}")
            
            # åœ¨å¤„ç†ä¸‹ä¸€ä¸ªidentityä¹‹å‰æ·»åŠ å»¶è¿Ÿ
            if is_bedrock and idx < total:
                time.sleep(delay)
                
        except Exception as e:
            print(f"âŒ Error: {e}")
            if is_bedrock:
                print(f"â¸ï¸  Waiting {delay * 3}s before continuing...")
                time.sleep(delay * 3)
            continue
    
    # è¾“å‡ºç»“æœ
    results = bias.get_results()
    print(f"\n{'='*60}")
    print(f"RESULTS (Model: {model_id}):")
    print(f"{'='*60}")
    print(f"Republican Votes: {results['Republican']}")
    print(f"Democratic Votes: {results['Democratic']}")
    print(f"No Preference Votes: {results['No Preference']}")
    print(f"Total Processed: {sum(results.values())}")
    print(f"{'='*60}\n")
    
    # ä¿å­˜ç»“æœ
    results_dir = 'responses'
    os.makedirs(results_dir, exist_ok=True)
    
    with open(os.path.join(results_dir, 'votes.txt'), 'w') as f:
        f.write(f"Model: {model_id}\n")
        f.write(f"LLM Generated Ideology: {use_llm_ideology}\n")
        f.write(f"Candidate Info Added: {add_candidate_info}\n")
        f.write("Final Voting Results:\n")
        f.write(f"Republican Votes: {results['Republican']}\n")
        f.write(f"Democratic Votes: {results['Democratic']}\n")
        f.write(f"No Preference Votes: {results['No Preference']}\n")
        f.write(f"Total Processed: {sum(results.values())}\n")


if __name__ == "__main__":
    import sys
    
    delay = 2.0  # Bedrockéœ€è¦æ›´é•¿çš„å»¶è¿Ÿï¼Œå› ä¸ºæ¯ä¸ªidentityè¦è°ƒç”¨ä¸¤æ¬¡API
    add_candidate_info = True
    use_llm_ideology = True
    
    if "--list" in sys.argv:
        main(show_models=True)
    else:
        model_id = DEFAULT_MODEL
        
        if "--model" in sys.argv:
            model_idx = sys.argv.index("--model")
            if model_idx + 1 < len(sys.argv):
                model_id = sys.argv[model_idx + 1]
            else:
                print("Error: --model requires a model_id argument")
                exit(1)
        
        if "--delay" in sys.argv:
            delay_idx = sys.argv.index("--delay")
            if delay_idx + 1 < len(sys.argv):
                try:
                    delay = float(sys.argv[delay_idx + 1])
                except ValueError:
                    print("Error: --delay requires a numeric value")
                    exit(1)
        
        if "--no-candidate-info" in sys.argv:
            add_candidate_info = False
        
        if "--no-llm-ideology" in sys.argv:
            use_llm_ideology = False
        
        main(
            model_id=model_id, 
            delay=delay, 
            add_candidate_info=add_candidate_info,
            use_llm_ideology=use_llm_ideology
        )